# @format

name: Cleanup old artifacts

on:
  schedule:
    # Runs daily at 05:00 UTC (adjust as needed)
    - cron: "0 5 * * *"
  workflow_dispatch:
    inputs:
      ageHours:
        description: "Delete artifacts older than this many hours"
        required: false
        default: "48"

permissions:
  contents: read
  actions: write

jobs:
  cleanup:
    name: Delete artifacts older than 48h
    runs-on: ubuntu-latest

    steps:
      - name: Delete old artifacts
        uses: actions/github-script@v7
        env:
          AGE_HOURS: ${{ inputs.ageHours || '48' }}
        with:
          script: |
            const ageHoursRaw = process.env.AGE_HOURS || '48';
            const ageHours = Number(ageHoursRaw);
            if (!Number.isFinite(ageHours) || ageHours <= 0) {
              core.setFailed(`Invalid AGE_HOURS: ${ageHoursRaw}`);
              return;
            }

            const thresholdMs = Date.now() - ageHours * 60 * 60 * 1000;
            core.info(`Deleting artifacts older than ${ageHours} hours (created before ${new Date(thresholdMs).toISOString()})`);

            const artifacts = await github.paginate(github.rest.actions.listArtifactsForRepo, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100,
            });

            core.info(`Found ${artifacts.length} total artifacts`);

            let deleted = 0;
            let skipped = 0;

            for (const artifact of artifacts) {
              if (!artifact || artifact.expired) {
                skipped++;
                continue;
              }

              const createdAtMs = Date.parse(artifact.created_at);
              if (!Number.isFinite(createdAtMs)) {
                skipped++;
                continue;
              }

              if (createdAtMs >= thresholdMs) {
                skipped++;
                continue;
              }

              core.info(`Deleting artifact #${artifact.id} "${artifact.name}" created_at=${artifact.created_at}`);
              await github.rest.actions.deleteArtifact({
                owner: context.repo.owner,
                repo: context.repo.repo,
                artifact_id: artifact.id,
              });
              deleted++;
            }

            core.info(`Done. Deleted: ${deleted}, skipped: ${skipped}`);
